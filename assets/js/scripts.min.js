/**
 * Pilpil v1.0.0 - Progressive Image Loading
 * @link https://zafree.github.io/pilpil
 * @copyright 2015-2016 Zafree
 * @license MIT
 */
 ;(function() {
 	'use strict';
 	

	// set progressive image loading
	var progressiveMedias = document.querySelectorAll('.progressiveMedia');
	for (var i = 0; i < progressiveMedias.length; i++) {
		loadImage(progressiveMedias[i]);
	}

	// global function
	function loadImage(progressiveMedia) {

		// calculate aspect ratio
		// for the aspectRatioPlaceholder-fill
		// that helps to set a fixed fill for loading images
		var width = progressiveMedia.dataset.width,
		height = progressiveMedia.dataset.height,
		fill = height / width * 100,
		placeholderFill = progressiveMedia.previousElementSibling;

		placeholderFill.setAttribute('style', 'padding-bottom:'+fill+'%;');



		// get thumbnail height wight
		// make canvas fun part
		var thumbnail = progressiveMedia.querySelector('.progressiveMedia-thumbnail'),
		smImageWidth = thumbnail.width,
		smImageheight = thumbnail.height,

		canvas = progressiveMedia.querySelector('.progressiveMedia-canvas'),
		context = canvas.getContext('2d');

		canvas.height = smImageheight;
		canvas.width = smImageWidth;

		var img = new Image();
		img.src = thumbnail.src;

		img.onload = function () {
			// context.drawImage(img, 0, 0);
			// draw canvas
			var canvasImage = new CanvasImage(canvas, img);
			canvasImage.blur(2);

			// load canvas visible
			progressiveMedia.classList.add('is-canvasLoaded');
		};
	}

	//Show images when in viewpoint
	jQuery(window).on('load',function(){
		//Window width & height
		var viewpointWidth = jQuery(window).width(),
		viewpointHeight = jQuery(window).height(),
		//Document Top pos & Left pos
		documentScrollTop = jQuery(document).scrollTop(),
		documentScrollLeft = jQuery(document).scrollLeft(),
		//Document Positions
		minTop = documentScrollTop,
		maxTop = documentScrollTop + viewpointHeight,
		minLeft = documentScrollLeft,
		maxLeft = documentScrollLeft + viewpointWidth;

		// grab data-src from original image
		// from progressiveMedia-image
		//Loop for each image
		var all_images = jQuery(".progressiveMedia-image");
		all_images.each(function(index){
			var $self = jQuery(this),
			$selfOffset = $self.offset(),
			$imageSrc = $self.data("src"),
			$imageSrc_inCSS = 'url("'+ $imageSrc +'")',
			$notAlreadyLoaded;

			if ($self.css('backgroundImage') == $imageSrc_inCSS) {
				$notAlreadyLoaded = true;
			}else{
				$notAlreadyLoaded = false;
			}

			if (!$imageSrc=="") {
				function elementScrolled(elem){
					var docViewTop = jQuery(window).scrollTop();
					var docViewBottom = docViewTop + jQuery(window).height();
					var elemTop = jQuery(elem).offset().top;
					return ((elemTop <= docViewBottom) && (elemTop >= docViewTop));
				}
				jQuery(window).scroll(function(){
    					// This is then function used to detect if the element is scrolled into view
    					if(elementScrolled($self)) {
    						$notAlreadyLoaded = ($self.css('backgroundImage') == $imageSrc_inCSS);
    						if (!$notAlreadyLoaded) {
    							$self.css({"background-image":'url("'+ $imageSrc +'")'})
    							$self.parent().addClass('is-imageLoaded');
    						}
    					}
    				});
			}
		});
	});

})();


// canvas blur function
CanvasImage = function (e, t) {
	this.image = t;
	this.element = e;
	e.width = t.width;
	e.height = t.height;
	this.context = e.getContext('2d');
	this.context.drawImage(t, 0, 0);
};

CanvasImage.prototype = {
	blur:function(e) {
		this.context.globalAlpha = 0.5;
		for(var t = -e; t <= e; t += 2) {
			for(var n = -e; n <= e; n += 2) {
				this.context.drawImage(this.element, n, t);
				var blob = n >= 0 && t >= 0 && this.context.drawImage(this.element, -(n -1), -(t-1));
			}
		}
	}
}

document.addEventListener("DOMContentLoaded",function(){
	"use strict";
	console.clear();

	// fade out when clicks on external link - smooth animation :)
	jQuery('a.external').click(function(e) {
		e.preventDefault();
		var link = jQuery(this).attr('href');
		jQuery('body').fadeOut('50', function() {
			window.location.href = link; 
		});
	});








/*

	jQuery('.menu-item-has-children').children('a').append('<span class="icon ti-angle-down">')
	jQuery('.menu-item-has-children').click(function(e) {
		e.preventDefault();
	});
	jQuery('.sub-menu').addClass('align-center');
	function menuController() {
		if(jQuery(window).width() <= 768){
			jQuery('.menu-item-has-children').addClass('on-js');
		}else{
			jQuery('.menu-item-has-children').removeClass('on-js');
		}
	}
	menuController();	
	jQuery(window).resize(function () {
		menuController();	
	});
	jQuery('.showsearch').click(function() {
		jQuery('#searchbar').toggleClass('display_search');
	});

	jQuery('.close_search').click(function() {
		jQuery('#searchbar').toggleClass('display_search');
	});

	jQuery('#menu-trigger').on("click",function(e){
		e.preventDefault();
		jQuery(this).find("span.icon" ).toggleClass("ti-close");
		jQuery(this).siblings('.menu-primary-menu-container').children('#primary-menu').slideToggle();
	});

	jQuery('.menu-item-has-children.on-js').on("click",function(e){
		e.preventDefault();
		jQuery(this).find("span.icon" ).toggleClass("ti-angle-down");
		jQuery(this).find("span.icon" ).toggleClass("ti-angle-up");
		jQuery(this).children('.sub-menu').slideToggle();
	});


*/










	jQuery('.showsearch').click(function() {
		jQuery('#searchbar').toggleClass('display_search');
	});

	jQuery('.close_search').click(function() {
		jQuery('#searchbar').toggleClass('display_search');
	});

	jQuery('.showdrawer').click(function() { 
		jQuery('.main_drawer').toggleClass('show');
		jQuery('.overlay').toggleClass('show');
	});

	jQuery('.closedrawer').click(function() {
		jQuery('.main_drawer').toggleClass('show');
		jQuery('.overlay').toggleClass('show');
	});

	jQuery(".overlay").click(function() {
		jQuery('.overlay').toggleClass('show');
		jQuery('.main_drawer').toggleClass('show');
	});

	jQuery(".drawer li.has-submenu > a").on("click",function(e){
		e.preventDefault();
		var triggerer = jQuery(this).parent();
		jQuery("a span", triggerer ).toggleClass("ti-angle-down");
		jQuery("a span", triggerer ).toggleClass("ti-angle-up");
		jQuery(".submenu", triggerer ).slideToggle();
	});
});
